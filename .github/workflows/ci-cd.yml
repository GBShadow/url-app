name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
env:
  JWT_PRIVATE_KEY: ${{ vars.JWT_PRIVATE_KEY }}
  JWT_PUBLIC_KEY: ${{ vars.JWT_PUBLIC_KEY }}
  DATABASE_URL: ${{ vars.DATABASE_URL }}
  DOMAIN: ${{ vars.DOMAIN }}
  PORT: ${{ vars.PORT }}
jobs:
  ci:
    name: 🔍 Lint & Test (Docker Compose)
    runs-on: ubuntu-latest
    environment: dev

    services:
      docker:
        image: docker:20.10.24-dind

    steps:
      - name: 📥 Checkout código
        uses: actions/checkout@v4

      - name: 🐳 Set up Docker Compose
        run: |
          docker compose --version
      
      - name: 🐳 Build e subir containers
        env:
          JWT_PRIVATE_KEY: ${{ vars.JWT_PRIVATE_KEY }}
          JWT_PUBLIC_KEY: ${{ vars.JWT_PUBLIC_KEY }}
          DATABASE_URL: ${{ vars.DATABASE_URL }}
          DOMAIN: ${{ vars.DOMAIN }}
          PORT: ${{ vars.PORT }}
        run: |
          docker compose -f docker-compose.test.yml up -d --build
          docker compose ps

      - name: ⏳ Aguardar serviços subirem
        run: |
          sleep 15

      - name: ✅ Rodar Lint (dentro do container app)
        run: docker exec app_test npm run lint

      - name: 🧪 Testes Unitários
        run: docker exec app_test npm run test

      - name: 🚫 Parar containers
        if: always()
        run: docker compose down
