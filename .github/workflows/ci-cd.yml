name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
env:
  JWT_PRIVATE_KEY: ${{ vars.JWT_PRIVATE_KEY }}
  JWT_PUBLIC_KEY: ${{ vars.JWT_PUBLIC_KEY }}
  DATABASE_URL: ${{ vars.DATABASE_URL }}
  DOMAIN: ${{ vars.DOMAIN }}
  PORT: ${{ vars.PORT }}
jobs:
  ci:
    name: ğŸ” Lint & Test (Docker Compose)
    runs-on: ubuntu-latest
    environment: dev

    services:
      docker:
        image: docker:20.10.24-dind

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Compose
        run: |
          docker compose --version
      
      - name: ğŸ³ Build e subir containers
        env:
          JWT_PRIVATE_KEY: ${{ vars.JWT_PRIVATE_KEY }}
          JWT_PUBLIC_KEY: ${{ vars.JWT_PUBLIC_KEY }}
          DATABASE_URL: ${{ vars.DATABASE_URL }}
          DOMAIN: ${{ vars.DOMAIN }}
          PORT: ${{ vars.PORT }}
        run: |
          docker compose -f docker-compose.test.yml up -d --build
          docker compose ps

      - name: â³ Aguardar serviÃ§os subirem
        run: |
          sleep 15

      - name: âœ… Rodar Lint (dentro do container app)
        run: docker exec app_test npm run lint

      - name: ğŸ§ª Testes UnitÃ¡rios
        run: docker exec app_test npm run test

      - name: ğŸš« Parar containers
        if: always()
        run: docker compose down
